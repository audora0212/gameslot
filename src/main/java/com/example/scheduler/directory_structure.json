{
    "__files__": {
        "codes.py": null,
        "directory_structure.json": null,
        "SchedulerApplication.java": "package com.example.scheduler;\n\nimport org.springframework.boot.SpringApplication;\nimport org.springframework.boot.autoconfigure.SpringBootApplication;\nimport org.springframework.scheduling.annotation.EnableScheduling;\n\n@SpringBootApplication\n@EnableScheduling\npublic class SchedulerApplication {\n\n\tpublic static void main(String[] args) {\n\t\tSpringApplication.run(SchedulerApplication.class, args);\n\t}\n\n}\n"
    },
    "controller": {
        "__files__": {
            "AuthController.java": "package com.example.scheduler.controller;\n\nimport com.example.scheduler.dto.AuthDto;\nimport com.example.scheduler.service.AuthService;\nimport lombok.RequiredArgsConstructor;\nimport org.springframework.http.HttpStatus;\nimport org.springframework.http.ResponseEntity;\nimport org.springframework.security.core.AuthenticationException;\nimport org.springframework.web.bind.annotation.*;\n\nimport java.util.Map;\n\n@RestController\n@RequestMapping(\"/api/auth\")\n@RequiredArgsConstructor\npublic class AuthController {\n\n    private final AuthService authService;\n\n    /* ---------- 회원가입 ---------- */\n    @PostMapping(\"/signup\")\n    public ResponseEntity<AuthDto.SignupResponse> signup(@RequestBody AuthDto.SignupRequest req) {\n        authService.signup(req);\n        return ResponseEntity.ok(new AuthDto.SignupResponse(\"회원가입이 완료되었습니다\"));\n    }\n\n    /* ---------- 로그인 ---------- */\n    @PostMapping(\"/login\")\n    public ResponseEntity<?> login(@RequestBody AuthDto.LoginRequest req) {\n        try {\n            String token = authService.login(req);\n            return ResponseEntity.ok(new AuthDto.LoginResponse(token, \"로그인 성공\"));\n        } catch (AuthenticationException ex) {\n            return ResponseEntity.status(HttpStatus.UNAUTHORIZED)\n                    .body(Map.of(\"message\", \"아이디 또는 비밀번호가 올바르지 않습니다\"));\n        }\n    }\n\n    /* ---------- 로그아웃 ---------- */\n    @PostMapping(\"/logout\")\n    public ResponseEntity<?> logout(@RequestHeader(\"Authorization\") String authHeader) {\n        authService.logout(authHeader);\n        return ResponseEntity.ok(Map.of(\"message\", \"로그아웃되었습니다\"));\n    }\n}\n",
            "GameController.java": "// controller/GameController.java\npackage com.example.scheduler.controller;\n\nimport com.example.scheduler.dto.GameDto;\nimport com.example.scheduler.service.GameService;\nimport lombok.RequiredArgsConstructor;\nimport org.springframework.http.ResponseEntity;\nimport org.springframework.web.bind.annotation.*;\n\nimport java.util.List;\n\n@RestController\n@RequestMapping(\"/api\")\n@RequiredArgsConstructor\npublic class GameController {\n\n    private final GameService gameService;\n\n    /* ---------- 기본 / 커스텀 게임 조회 ---------- */\n\n    @GetMapping(\"/games/default\")\n    public ResponseEntity<GameDto.DefaultGameListResponse> getDefaultGames() {\n        List<GameDto.DefaultGameResponse> list = gameService.listAllDefault();\n        return ResponseEntity.ok(new GameDto.DefaultGameListResponse(list));\n    }\n\n    @GetMapping(\"/servers/{serverId}/custom-games\")\n    public ResponseEntity<GameDto.CustomGameListResponse> getCustomGames(@PathVariable Long serverId) {\n        List<GameDto.CustomGameResponse> list = gameService.listCustomByServer(serverId);\n        return ResponseEntity.ok(new GameDto.CustomGameListResponse(list));\n    }\n\n    /* ---------- 커스텀 게임 추가 / 삭제 ---------- */\n\n    @PostMapping(\"/servers/{serverId}/custom-games\")\n    public ResponseEntity<GameDto.CustomGameResponse> addCustomGame(\n            @PathVariable Long serverId,\n            @RequestBody GameDto.CustomGameRequest req) {\n        return ResponseEntity.ok(gameService.addCustomGame(serverId, req));\n    }\n\n    @DeleteMapping(\"/servers/{serverId}/custom-games/{gameId}\")   // ⭐ 커스텀 게임 삭제\n    public ResponseEntity<Void> deleteCustomGame(\n            @PathVariable Long serverId,\n            @PathVariable Long gameId) {\n        gameService.deleteCustomGame(serverId, gameId);\n        return ResponseEntity.noContent().build();\n    }\n    @GetMapping(\"/servers/{serverId}/custom-games/{gameId}/scheduled-users\")\n    public ResponseEntity<GameDto.ScheduledUserListResponse> getScheduledUsers(\n            @PathVariable Long serverId,\n            @PathVariable Long gameId\n    ) {\n        return ResponseEntity.ok(gameService.listScheduledUsers(serverId, gameId));\n    }\n\n}\n",
            "ServerController.java": "// controller/ServerController.java\npackage com.example.scheduler.controller;\n\nimport com.example.scheduler.dto.ServerDto;\nimport com.example.scheduler.service.ServerService;\nimport lombok.RequiredArgsConstructor;\nimport org.springframework.http.ResponseEntity;\nimport org.springframework.web.bind.annotation.*;\n\nimport java.util.List;\n\n@RestController\n@RequestMapping(\"/api/servers\")\n@RequiredArgsConstructor\npublic class ServerController {\n\n    private final ServerService serverService;\n\n    /* ---------- 생성·참가 ---------- */\n\n    // 내가 속한 서버들\n    @GetMapping(\"/mine\")\n    public ResponseEntity<List<ServerDto.Response>> listMine() {\n        return ResponseEntity.ok(serverService.listMine());\n    }\n\n    // 서버 검색 (페이징)\n    @GetMapping(\"/search\")\n    public ResponseEntity<List<ServerDto.Response>> search(\n            @RequestParam(required = false) String q,\n            @RequestParam(defaultValue = \"0\") int page,\n            @RequestParam(defaultValue = \"10\") int size\n    ) {\n        return ResponseEntity.ok(serverService.search(q, page, size));\n    }\n\n    @PostMapping\n    public ResponseEntity<ServerDto.Response> create(@RequestBody ServerDto.CreateRequest req) {\n        return ResponseEntity.ok(serverService.create(req));\n    }\n\n    @PostMapping(\"/{id}/join\")\n    public ResponseEntity<ServerDto.Response> join(@PathVariable Long id) {\n        return ResponseEntity.ok(serverService.join(id));\n    }\n\n    /* ---------- 일반 수정 ---------- */\n\n    @PutMapping(\"/{id}/reset-time\")\n    public ResponseEntity<ServerDto.Response> updateResetTime(\n            @PathVariable Long id,\n            @RequestBody ServerDto.UpdateResetTimeRequest req) {\n        return ResponseEntity.ok(serverService.updateResetTime(id, req));\n    }\n\n    @PutMapping(\"/{id}/name\")                           // ⭐ 서버 이름 변경\n    public ResponseEntity<ServerDto.Response> rename(\n            @PathVariable Long id,\n            @RequestBody ServerDto.UpdateNameRequest req) {\n        return ResponseEntity.ok(serverService.rename(id, req));\n    }\n\n    /* ---------- 관리자 기능 ---------- */\n\n    @PostMapping(\"/{id}/kick\")                          // 멤버 강퇴\n    public ResponseEntity<ServerDto.Response> kick(\n            @PathVariable Long id,\n            @RequestBody ServerDto.KickRequest req) {\n        return ResponseEntity.ok(serverService.kick(id, req));\n    }\n\n    @PostMapping(\"/{id}/admins\")                        // 관리자 임명/해제\n    public ResponseEntity<ServerDto.Response> updateAdmin(\n            @PathVariable Long id,\n            @RequestBody ServerDto.AdminRequest req) {\n        return ResponseEntity.ok(serverService.updateAdmin(id, req));\n    }\n\n    @DeleteMapping(\"/{id}\")                             // 서버 삭제\n    public ResponseEntity<Void> delete(@PathVariable Long id) {\n        serverService.delete(id);\n        return ResponseEntity.noContent().build();\n    }\n\n    /* ---------- 조회 ---------- */\n\n    @GetMapping\n    public ResponseEntity<List<ServerDto.Response>> list() {\n        return ResponseEntity.ok(serverService.list());\n    }\n\n    @GetMapping(\"/{id}\")\n    public ResponseEntity<ServerDto.Response> detail(@PathVariable Long id) {\n        return ResponseEntity.ok(serverService.getDetail(id));\n    }\n}\n",
            "TimetableController.java": "// controller/TimetableController.java\npackage com.example.scheduler.controller;\n\nimport com.example.scheduler.dto.TimetableDto;\nimport com.example.scheduler.service.TimetableService;\nimport lombok.RequiredArgsConstructor;\nimport org.springframework.http.ResponseEntity;\nimport org.springframework.web.bind.annotation.*;\nimport java.util.List;\n\n@RestController\n@RequestMapping(\"/api/servers/{serverId}/timetable\")\n@RequiredArgsConstructor\npublic class TimetableController {\n    private final TimetableService timetableService;\n\n    @PostMapping\n    public ResponseEntity<TimetableDto.EntryResponse> add(\n            @PathVariable Long serverId,\n            @RequestBody TimetableDto.EntryRequest req) {\n        req.setServerId(serverId);\n        return ResponseEntity.ok(timetableService.add(req));\n    }\n\n    @GetMapping\n    public ResponseEntity<List<TimetableDto.EntryResponse>> list(\n            @PathVariable Long serverId,\n            @RequestParam(required = false) String game,\n            @RequestParam(defaultValue = \"false\") boolean sortByGame) {\n        return ResponseEntity.ok(timetableService.list(serverId, game, sortByGame));\n    }\n\n    @GetMapping(\"/stats\")\n    public ResponseEntity<TimetableDto.StatsResponse> stats(@PathVariable Long serverId) {\n        return ResponseEntity.ok(timetableService.stats(serverId));\n    }\n}"
        }
    },
    "domain": {
        "__files__": {
            "BlacklistedToken.java": "package com.example.scheduler.domain;\n\nimport jakarta.persistence.*;\nimport lombok.*;\n\nimport java.util.Date;\n\n@Entity\n@Getter @Setter @NoArgsConstructor @AllArgsConstructor @Builder\n@Table(name = \"blacklisted_tokens\")\npublic class BlacklistedToken {\n\n    @Id @GeneratedValue(strategy = GenerationType.IDENTITY)\n    private Long id;\n\n    @Column(nullable = false, unique = true, length = 500)\n    private String token;          // 실제 JWT 문자열\n\n    @Column(nullable = false)\n    @Temporal(TemporalType.TIMESTAMP)\n    private Date expiry;           // JWT 만료 시각\n}\n",
            "CustomGame.java": "package com.example.scheduler.domain;\n\nimport jakarta.persistence.*;\nimport lombok.*;\n\n@Entity\n@Getter @Setter @NoArgsConstructor @AllArgsConstructor @Builder\npublic class CustomGame {\n    @Id\n    @GeneratedValue(strategy = GenerationType.IDENTITY)\n    private Long id; //커스텀 게임 아이디\n\n    @Column(nullable = false)\n    private String name; //커스텀 게임 이름\n\n    @ManyToOne(optional = false)\n    @JoinColumn(name = \"server_id\")\n    private Server server; //어느 서버에 종속 되었는지\n}\n",
            "DefaultGame.java": "package com.example.scheduler.domain;\n\nimport jakarta.persistence.*;\nimport lombok.*;\n\n@Entity\n@Getter @Setter @NoArgsConstructor @AllArgsConstructor @Builder\npublic class DefaultGame {\n    @Id\n    @GeneratedValue(strategy = GenerationType.IDENTITY)\n    private Long id; //기본 게임 아이디\n\n    @Column(nullable = false, unique = true)\n    private String name; //기본 게임 이름\n}\n",
            "Server.java": "// domain/Server.java\npackage com.example.scheduler.domain;\n\nimport jakarta.persistence.*;\nimport lombok.*;\n\nimport java.time.LocalTime;\nimport java.util.Set;\n\n@Entity\n@Getter @Setter @NoArgsConstructor @AllArgsConstructor @Builder\npublic class Server {\n\n    @Id\n    @GeneratedValue(strategy = GenerationType.IDENTITY)\n    private Long id;                      // 서버 ID\n\n    @Column(nullable = false)\n    private String name;                  // 서버 이름\n\n    @ManyToOne(optional = false)\n    @JoinColumn(name = \"owner_id\")\n    private User owner;                   // 서버장\n\n    @ManyToMany\n    @JoinTable(name = \"server_members\",\n            joinColumns = @JoinColumn(name = \"server_id\"),\n            inverseJoinColumns = @JoinColumn(name = \"user_id\"))\n    private Set<User> members;            // 서버 멤버\n\n    // ⭐ 추가: 서버 관리자 집합 (owner 포함)\n    @ManyToMany\n    @JoinTable(name = \"server_admins\",\n            joinColumns = @JoinColumn(name = \"server_id\"),\n            inverseJoinColumns = @JoinColumn(name = \"user_id\"))\n    private Set<User> admins;\n\n    @OneToMany(mappedBy = \"server\", cascade = CascadeType.ALL, orphanRemoval = true)\n    private Set<TimetableEntry> entries;  // 타임테이블 엔트리\n\n    @Column(nullable = false)\n    private LocalTime resetTime;          // 타임테이블 초기화 시각\n}\n",
            "TimetableEntry.java": "package com.example.scheduler.domain;\n\nimport jakarta.persistence.*;\nimport lombok.*;\nimport java.time.LocalDateTime;\n\n@Entity\n@Getter @Setter @NoArgsConstructor @AllArgsConstructor @Builder\npublic class TimetableEntry {\n    @Id\n    @GeneratedValue(strategy = GenerationType.IDENTITY)\n    private Long id; //테이블 기록 아이디\n\n    @ManyToOne(optional = false)\n    @JoinColumn(name = \"server_id\")\n    private Server server; //테이블 기록할 서버 아이디\n\n    @ManyToOne(optional = false)\n    @JoinColumn(name = \"user_id\")\n    private User user; //테이블 기록할 유저 아이디\n\n    @Column(nullable = false)\n    private LocalDateTime slot; //어느 시간 슬롯에 넣을지\n\n    @ManyToOne\n    @JoinColumn(name = \"default_game_id\")\n    private DefaultGame defaultGame; //일반 게임인 경우\n\n    @ManyToOne\n    @JoinColumn(name = \"custom_game_id\")\n    private CustomGame customGame; //커스텀 게임인 경우\n}\n",
            "User.java": "package com.example.scheduler.domain;\n\nimport jakarta.persistence.*;\nimport lombok.*;\nimport java.util.Set;\n\n@Entity\n@Getter @Setter @NoArgsConstructor @AllArgsConstructor @Builder\npublic class User { // Discord OAuth 추가 이후 필요한 항목들 추가\n    @Id @GeneratedValue(strategy = GenerationType.IDENTITY)\n    private Long id; //유저 아이디\n\n    @Column(unique = true, nullable = false)\n    private String username; //유저 이름\n\n    @Column(nullable = false)\n    private String password; //비밀번호\n\n    @ManyToMany(mappedBy = \"members\")\n    private Set<Server> joinedServers; //참여중인 서버\n}"
        }
    },
    "dto": {
        "__files__": {
            "AuthDto.java": "package com.example.scheduler.dto;\n\nimport lombok.AllArgsConstructor;\nimport lombok.Data;\n\npublic class AuthDto {\n    @Data public static class SignupRequest { //회원가입 요청\n        private String username;\n        private String password;\n    }\n    @Data @AllArgsConstructor public static class SignupResponse { //회원가입 성공여부\n        private String message;\n    }\n\n    @Data public static class LoginRequest  { //로그인 요청\n        private String username;\n        private String password;\n    }\n    @Data @AllArgsConstructor public static class LoginResponse  { //로그인 성공여부, 토큰\n        private String token;\n        private String message;\n    }\n}\n",
            "GameDto.java": "package com.example.scheduler.dto;\n\nimport lombok.*;\nimport java.util.List;\n\npublic class GameDto {\n\n    @Data\n    @NoArgsConstructor\n    @AllArgsConstructor\n    public static class DefaultGameResponse {\n        private Long id;\n        private String name;\n    }\n\n    @Data\n    @NoArgsConstructor\n    @AllArgsConstructor\n    public static class CustomGameRequest {\n        private String name;\n    }\n\n    @Data\n    @NoArgsConstructor\n    @AllArgsConstructor\n    public static class CustomGameResponse {\n        private Long id;\n        private String name;\n    }\n\n    @Data\n    @AllArgsConstructor\n    public static class DefaultGameListResponse {\n        private List<DefaultGameResponse> defaultGames;\n    }\n\n    @Data\n    @AllArgsConstructor\n    public static class CustomGameListResponse {\n        private List<CustomGameResponse> customGames;\n    }\n\n    @Data\n    @AllArgsConstructor\n    public static class ScheduledUserResponse {\n        private String username;\n    }\n\n    @Data\n    @AllArgsConstructor\n    public static class ScheduledUserListResponse {\n        private List<ScheduledUserResponse> users;\n    }\n}\n",
            "ServerDto.java": "// dto/ServerDto.java\npackage com.example.scheduler.dto;\n\nimport lombok.*;\n\nimport java.time.LocalTime;\nimport java.util.List;\nimport java.util.Set;\n\npublic class ServerDto {\n\n    /* ---------- 요청용 DTO ---------- */\n\n    @Data\n    public static class CreateRequest {\n        private String name;\n        private LocalTime resetTime;\n    }\n\n    @Data\n    public static class UpdateResetTimeRequest {\n        private LocalTime resetTime;\n    }\n\n    @Data                // 서버 이름 변경\n    public static class UpdateNameRequest {\n        private String name;\n    }\n\n    @Data                // 멤버 강퇴\n    public static class KickRequest {\n        private Long userId;\n    }\n\n    @Data                // 관리자 임명/해제\n    public static class AdminRequest {\n        private Long userId;\n        private boolean grant;   // true: 임명, false: 해제\n    }\n\n    /* ---------- 응답용 DTO ---------- */\n\n    @Data\n    @AllArgsConstructor\n    public static class Response {\n        private Long id;\n        private String name;\n        private String owner;\n        private List<MemberInfo> members;\n        private List<MemberInfo> admins;\n        private LocalTime resetTime;\n    }\n\n    @Data @AllArgsConstructor\n    public static class MemberInfo {\n        private Long id;\n        private String username;\n    }\n}\n",
            "TimetableDto.java": "package com.example.scheduler.dto;\n\nimport lombok.Data;\nimport lombok.AllArgsConstructor;\nimport java.time.LocalDateTime;\n\npublic class TimetableDto {\n    @Data\n    public static class EntryRequest {\n        private Long serverId;\n        private LocalDateTime slot;\n        private Long defaultGameId;\n        private Long customGameId;\n    }\n\n    @Data\n    public static class EntryResponse {\n        private Long id;\n        private String user;\n        private LocalDateTime slot;\n        private Long gameId;\n        private String gameName;\n        private boolean custom;\n    }\n\n    @Data\n    @AllArgsConstructor\n    public static class StatsResponse {\n        private String topGame;\n        private LocalDateTime avgSlot;\n        private LocalDateTime peakSlot;\n        private int peakCount;\n    }\n}\n"
        }
    },
    "repository": {
        "__files__": {
            "BlacklistedTokenRepository.java": "package com.example.scheduler.repository;\n\nimport com.example.scheduler.domain.BlacklistedToken;\nimport org.springframework.data.jpa.repository.JpaRepository;\n\nimport java.util.Date;\n\npublic interface BlacklistedTokenRepository extends JpaRepository<BlacklistedToken, Long> {\n    boolean existsByToken(String token);\n    void deleteAllByExpiryBefore(Date now);      // 만료된 블랙리스트 토큰 정리\n}\n",
            "CustomGameRepository.java": "package com.example.scheduler.repository;\n\nimport com.example.scheduler.domain.CustomGame;\nimport com.example.scheduler.domain.Server;\nimport org.springframework.data.jpa.repository.JpaRepository;\nimport java.util.List;\n\npublic interface CustomGameRepository extends JpaRepository<CustomGame, Long> {\n    List<CustomGame> findByServer(Server server);\n}\n",
            "DefaultGameRepository.java": "package com.example.scheduler.repository;\n\nimport com.example.scheduler.domain.DefaultGame;\nimport org.springframework.data.jpa.repository.JpaRepository;\nimport java.util.Optional;\n\npublic interface DefaultGameRepository extends JpaRepository<DefaultGame, Long> {\n    Optional<DefaultGame> findByName(String name);\n}\n",
            "ServerRepository.java": "package com.example.scheduler.repository;\n\nimport com.example.scheduler.domain.Server;\nimport com.example.scheduler.domain.User;\nimport org.springframework.data.domain.Page;\nimport org.springframework.data.domain.Pageable;\nimport org.springframework.data.jpa.repository.JpaRepository;\nimport java.time.LocalTime;\nimport java.util.List;\n\npublic interface ServerRepository extends JpaRepository<Server, Long> {\n    List<Server> findByResetTime(LocalTime resetTime);\n    // 내가 속한 서버 목록 조회\n    List<Server> findByMembersContains(User user);\n\n    // 이름 검색 + 페이징\n    Page<Server> findByNameContainingIgnoreCase(String name, Pageable pageable);\n}",
            "TimetableEntryRepository.java": "// repository/TimetableEntryRepository.java\npackage com.example.scheduler.repository;\n\nimport com.example.scheduler.domain.CustomGame;\nimport com.example.scheduler.domain.TimetableEntry;\nimport com.example.scheduler.domain.Server;\nimport com.example.scheduler.domain.User;\nimport org.springframework.data.jpa.repository.JpaRepository;\n\nimport java.time.LocalDateTime;\nimport java.util.List;\nimport java.util.Optional;\n\npublic interface TimetableEntryRepository extends JpaRepository<TimetableEntry, Long> {\n    List<TimetableEntry> findByServerOrderBySlot(Server server);\n    List<TimetableEntry> findByServerAndSlot(Server server, LocalDateTime slot);\n    Optional<TimetableEntry> findByServerAndUser(Server server, User user);\n    void deleteAllByServer(Server server);\n\n    // ↓ 추가 ↓\n    /** 특정 CustomGame을 예약한 모든 엔트리 */\n    List<TimetableEntry> findByCustomGame(CustomGame customGame);\n\n    /** 특정 CustomGame을 예약한 엔트리 전부 삭제 */\n    void deleteAllByCustomGame(CustomGame customGame);\n}\n",
            "UserRepository.java": "// repository/UserRepository.java\npackage com.example.scheduler.repository;\n\nimport com.example.scheduler.domain.User;\nimport org.springframework.data.jpa.repository.JpaRepository;\nimport java.util.Optional;\n\npublic interface UserRepository extends JpaRepository<User, Long> {\n    Optional<User> findByUsername(String username);\n    boolean existsByUsername(String username);\n}"
        }
    },
    "scheduler": {
        "__files__": {
            "BlacklistCleanupScheduler.java": "package com.example.scheduler.scheduler;\n\nimport com.example.scheduler.repository.BlacklistedTokenRepository;\nimport lombok.RequiredArgsConstructor;\nimport org.springframework.scheduling.annotation.Scheduled;\nimport org.springframework.stereotype.Component;\n\nimport java.util.Date;\n\n@Component\n@RequiredArgsConstructor\npublic class BlacklistCleanupScheduler {\n\n    private final BlacklistedTokenRepository blacklistRepo;\n\n    /* 매일 새벽 3시 정각: 만료된 블랙리스트 토큰 제거 */\n    @Scheduled(cron = \"0 0 3 * * *\")\n    public void cleanup() {\n        blacklistRepo.deleteAllByExpiryBefore(new Date());\n    }\n}\n",
            "TimetableResetScheduler.java": "package com.example.scheduler.scheduler;\n\nimport com.example.scheduler.domain.Server;\nimport com.example.scheduler.repository.ServerRepository;\nimport com.example.scheduler.repository.TimetableEntryRepository;\nimport jakarta.transaction.Transactional;\nimport lombok.RequiredArgsConstructor;\nimport org.springframework.scheduling.annotation.Scheduled;\nimport org.springframework.stereotype.Component;\n\nimport java.time.LocalTime;\nimport java.util.List;\n\n@Component\n@RequiredArgsConstructor\npublic class TimetableResetScheduler {\n    private final ServerRepository serverRepo;\n    private final TimetableEntryRepository entryRepo;\n\n    @Scheduled(cron = \"0 * * * * *\")\n    @Transactional\n    public void resetTimetables() {\n        LocalTime now = LocalTime.now().withSecond(0).withNano(0);\n        List<Server> servers = serverRepo.findByResetTime(now);\n        for (Server srv : servers) {\n            entryRepo.deleteAllByServer(srv);\n        }\n    }\n}"
        }
    },
    "security": {
        "__files__": {
            "JwtAuthenticationFilter.java": "// security/JwtAuthenticationFilter.java\npackage com.example.scheduler.security;\n\nimport org.springframework.security.core.context.SecurityContextHolder;\nimport org.springframework.security.core.userdetails.UserDetails;\nimport org.springframework.security.authentication.UsernamePasswordAuthenticationToken;\nimport org.springframework.security.web.authentication.WebAuthenticationDetailsSource;\nimport org.springframework.security.core.userdetails.UserDetailsService;\nimport org.springframework.web.filter.OncePerRequestFilter;\nimport jakarta.servlet.FilterChain;\nimport jakarta.servlet.ServletException;\nimport jakarta.servlet.http.HttpServletRequest;\nimport jakarta.servlet.http.HttpServletResponse;\nimport lombok.RequiredArgsConstructor;\n\nimport java.io.IOException;\n\n@RequiredArgsConstructor\npublic class JwtAuthenticationFilter extends OncePerRequestFilter {\n    private final JwtTokenProvider tokenProvider;\n    private final UserDetailsService userDetailsService;\n\n    @Override\n    protected void doFilterInternal(HttpServletRequest request,\n                                    HttpServletResponse response,\n                                    FilterChain chain)\n            throws IOException, ServletException {\n        String path = request.getServletPath();\n        // 인증이 필요 없는 엔드포인트 (/api/auth/**)는 필터링하지 않음\n        if (path.startsWith(\"/api/auth/**\")) {\n            chain.doFilter(request, response);\n            return;\n        }\n\n        String header = request.getHeader(\"Authorization\");\n        if (header != null && header.startsWith(\"Bearer \")) {\n            String token = header.substring(7);\n            if (tokenProvider.validateToken(token)) {\n                String username = tokenProvider.getUsername(token);\n                UserDetails userDetails = userDetailsService.loadUserByUsername(username);\n                UsernamePasswordAuthenticationToken auth =\n                        new UsernamePasswordAuthenticationToken(\n                                userDetails,\n                                null,\n                                userDetails.getAuthorities()\n                        );\n                auth.setDetails(new WebAuthenticationDetailsSource().buildDetails(request));\n                SecurityContextHolder.getContext().setAuthentication(auth);\n            }\n        }\n\n        chain.doFilter(request, response);\n    }\n}\n",
            "JwtTokenProvider.java": "package com.example.scheduler.security;\n\nimport com.example.scheduler.repository.BlacklistedTokenRepository;\nimport io.jsonwebtoken.*;\nimport io.jsonwebtoken.io.Decoders;\nimport io.jsonwebtoken.security.Keys;\nimport jakarta.annotation.PostConstruct;\nimport lombok.RequiredArgsConstructor;\nimport org.springframework.beans.factory.annotation.Value;\nimport org.springframework.stereotype.Component;\n\nimport java.security.Key;\nimport java.util.Date;\n\n@Component\n@RequiredArgsConstructor\npublic class JwtTokenProvider {\n\n    @Value(\"${jwt.secret}\")\n    private String secretBase64;\n\n    @Value(\"${jwt.expiration-ms}\")\n    private long validityInMs;\n\n    private final BlacklistedTokenRepository blacklistRepo;\n\n    private Key key;\n\n    @PostConstruct\n    public void init() {\n        byte[] keyBytes = Decoders.BASE64.decode(secretBase64);\n        this.key = Keys.hmacShaKeyFor(keyBytes);\n    }\n\n    /* ---------- 발행 ---------- */\n    public String createToken(String username) {\n        Date now    = new Date();\n        Date expiry = new Date(now.getTime() + validityInMs);\n\n        return Jwts.builder()\n                .setSubject(username)\n                .setIssuedAt(now)\n                .setExpiration(expiry)\n                .signWith(key, SignatureAlgorithm.HS256)\n                .compact();\n    }\n\n    /* ---------- 파싱 유틸 ---------- */\n    public String getUsername(String token) {\n        return parser().parseClaimsJws(token).getBody().getSubject();\n    }\n\n    public Date getExpiry(String token) {\n        return parser().parseClaimsJws(token).getBody().getExpiration();\n    }\n\n    private JwtParser parser() {\n        return Jwts.parserBuilder().setSigningKey(key).build();\n    }\n\n    /* ---------- 검증 ---------- */\n    public boolean validateToken(String token) {\n        try {\n            parser().parseClaimsJws(token);            // 서명·만료 검사\n            return !blacklistRepo.existsByToken(token); // 블랙리스트 검사\n        } catch (JwtException | IllegalArgumentException e) {\n            return false;\n        }\n    }\n}\n",
            "SecurityConfig.java": "package com.example.scheduler.security;\n\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.security.authentication.AuthenticationManager;\nimport org.springframework.security.config.annotation.authentication.configuration.AuthenticationConfiguration;\nimport org.springframework.security.config.annotation.web.builders.HttpSecurity;\nimport org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;\nimport org.springframework.security.config.http.SessionCreationPolicy;\nimport org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;\nimport org.springframework.security.crypto.password.PasswordEncoder;\nimport org.springframework.security.web.SecurityFilterChain;\nimport org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;\nimport org.springframework.web.cors.CorsConfiguration;\nimport org.springframework.web.cors.CorsConfigurationSource;\nimport org.springframework.web.cors.UrlBasedCorsConfigurationSource;\nimport org.springframework.security.config.Customizer;\n\nimport java.util.List;\n\n@Configuration\npublic class SecurityConfig {\n\n    // 기존에 @Autowired로 주입하셨던 bean들은 그대로 사용\n    private final JwtTokenProvider tokenProvider;\n    private final org.springframework.security.core.userdetails.UserDetailsService userDetailsService;\n\n    public SecurityConfig(JwtTokenProvider tokenProvider,\n                          org.springframework.security.core.userdetails.UserDetailsService userDetailsService) {\n        this.tokenProvider = tokenProvider;\n        this.userDetailsService = userDetailsService;\n    }\n\n    @Bean\n    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {\n        JwtAuthenticationFilter jwtFilter =\n                new JwtAuthenticationFilter(tokenProvider, userDetailsService);\n\n        http\n                // 1) CORS 설정 적용 (Customizer.withDefaults()로 대체)\n                .cors(Customizer.withDefaults())\n\n                // 2) CSRF 비활성화\n                .csrf(AbstractHttpConfigurer::disable)\n\n                // 3) 세션 정책 설정\n                .sessionManagement(session ->\n                        session.sessionCreationPolicy(SessionCreationPolicy.STATELESS)\n                )\n\n                // 4) 인가 규칙\n                .authorizeHttpRequests(auth ->\n                        auth\n                                .requestMatchers(\"/api/auth/**\", \"/error\").permitAll()\n                                .anyRequest().authenticated()\n                )\n\n                // 5) JWT 필터 등록\n                .addFilterBefore(jwtFilter, UsernamePasswordAuthenticationFilter.class);\n\n        return http.build();\n    }\n\n    @Bean\n    public CorsConfigurationSource corsConfigurationSource() {\n        CorsConfiguration cfg = new CorsConfiguration();\n        cfg.setAllowedOrigins(List.of(\"http://localhost:3000\"));\n        cfg.setAllowedMethods(List.of(\"GET\",\"POST\",\"PUT\",\"DELETE\",\"OPTIONS\"));\n        cfg.setAllowedHeaders(List.of(\"*\"));\n        cfg.setAllowCredentials(true);\n        cfg.setMaxAge(3600L);\n\n        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();\n        source.registerCorsConfiguration(\"/**\", cfg);\n        return source;\n    }\n\n    @Bean\n    public PasswordEncoder passwordEncoder() {\n        return new BCryptPasswordEncoder();\n    }\n    @Bean\n    public AuthenticationManager authenticationManager(\n            AuthenticationConfiguration authConfig\n    ) throws Exception {\n        return authConfig.getAuthenticationManager();\n    }\n}\n"
        }
    },
    "service": {
        "__files__": {
            "AuthService.java": "package com.example.scheduler.service;\n\nimport com.example.scheduler.domain.BlacklistedToken;\nimport com.example.scheduler.domain.User;\nimport com.example.scheduler.dto.AuthDto;\nimport com.example.scheduler.repository.BlacklistedTokenRepository;\nimport com.example.scheduler.repository.UserRepository;\nimport com.example.scheduler.security.JwtTokenProvider;\nimport lombok.RequiredArgsConstructor;\nimport org.springframework.http.HttpStatus;\nimport org.springframework.security.authentication.AuthenticationManager;\nimport org.springframework.security.authentication.UsernamePasswordAuthenticationToken;\nimport org.springframework.security.core.Authentication;\nimport org.springframework.security.crypto.password.PasswordEncoder;\nimport org.springframework.stereotype.Service;\nimport org.springframework.web.server.ResponseStatusException;\n\nimport java.util.Date;\n\n@Service\n@RequiredArgsConstructor\npublic class AuthService {\n\n    private final UserRepository userRepo;\n    private final PasswordEncoder encoder;\n    private final AuthenticationManager authManager;\n    private final JwtTokenProvider jwtProvider;\n\n    private final BlacklistedTokenRepository blacklistRepo;\n\n    /* ---------- 회원가입 & 로그인 ---------- */\n\n    public void signup(AuthDto.SignupRequest req) {\n        if (userRepo.existsByUsername(req.getUsername())) {\n            throw new ResponseStatusException(\n                    HttpStatus.BAD_REQUEST, \"이미 사용 중인 아이디입니다\");\n        }\n        User user = User.builder()\n                .username(req.getUsername())\n                .password(encoder.encode(req.getPassword()))\n                .build();\n        userRepo.save(user);\n    }\n\n    public String login(AuthDto.LoginRequest req) {\n        Authentication auth = authManager.authenticate(\n                new UsernamePasswordAuthenticationToken(req.getUsername(), req.getPassword()));\n        return jwtProvider.createToken(auth.getName());\n    }\n\n    /* ---------- 로그아웃 ---------- */\n    public void logout(String bearerHeader) {\n        if (bearerHeader == null || !bearerHeader.startsWith(\"Bearer \"))\n            throw new ResponseStatusException(HttpStatus.BAD_REQUEST, \"Authorization 헤더가 필요합니다\");\n\n        String token = bearerHeader.substring(7);\n\n        // 이미 무효 처리된 토큰인지 점검\n        if (!jwtProvider.validateToken(token))\n            throw new ResponseStatusException(HttpStatus.BAD_REQUEST, \"유효하지 않은 토큰입니다\");\n\n        Date expiry = jwtProvider.getExpiry(token);\n\n        blacklistRepo.save(\n                BlacklistedToken.builder()\n                        .token(token)\n                        .expiry(expiry)\n                        .build());\n    }\n}\n",
            "CustomUserDetailsService.java": "package com.example.scheduler.service;\n\nimport com.example.scheduler.domain.User;\nimport com.example.scheduler.repository.UserRepository;\nimport lombok.RequiredArgsConstructor;\nimport org.springframework.security.core.userdetails.UserDetails;\nimport org.springframework.security.core.userdetails.UserDetailsService;\nimport org.springframework.security.core.userdetails.UsernameNotFoundException;\nimport org.springframework.stereotype.Service;\nimport org.springframework.security.core.authority.SimpleGrantedAuthority;\nimport java.util.Collections;\n\n@Service\n@RequiredArgsConstructor\npublic class CustomUserDetailsService implements UserDetailsService {\n    private final UserRepository userRepository;\n\n    @Override\n    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {\n        User user = userRepository.findByUsername(username)\n                .orElseThrow(() -> new UsernameNotFoundException(\"User not found: \" + username));\n        return new org.springframework.security.core.userdetails.User(\n                user.getUsername(),\n                user.getPassword(),\n                Collections.singletonList(new SimpleGrantedAuthority(\"ROLE_USER\"))\n        );\n    }\n}\n",
            "GameService.java": "// service/GameService.java\npackage com.example.scheduler.service;\n\nimport com.example.scheduler.domain.CustomGame;\nimport com.example.scheduler.domain.DefaultGame;\nimport com.example.scheduler.domain.Server;\nimport com.example.scheduler.domain.User;\nimport com.example.scheduler.dto.GameDto;\nimport com.example.scheduler.repository.*;\nimport jakarta.transaction.Transactional;\nimport lombok.RequiredArgsConstructor;\nimport org.springframework.http.HttpStatus;\nimport org.springframework.security.core.context.SecurityContextHolder;\nimport org.springframework.stereotype.Service;\nimport org.springframework.web.server.ResponseStatusException;\n\nimport java.util.List;\nimport java.util.stream.Collectors;\n\n@Service\n@RequiredArgsConstructor\npublic class GameService {\n\n    private final DefaultGameRepository defaultGameRepo;\n    private final CustomGameRepository customGameRepo;\n    private final ServerRepository serverRepo;\n    private final UserRepository userRepo;\n    private final TimetableEntryRepository entryRepo;\n\n    /* ---------- 기본 / 커스텀 게임 조회 ---------- */\n\n    public List<GameDto.DefaultGameResponse> listAllDefault() {\n        return defaultGameRepo.findAll().stream()\n                .map(dg -> new GameDto.DefaultGameResponse(dg.getId(), dg.getName()))\n                .collect(Collectors.toList());\n    }\n\n    public List<GameDto.CustomGameResponse> listCustomByServer(Long serverId) {\n        Server srv = serverRepo.findById(serverId)\n                .orElseThrow(() -> new ResponseStatusException(HttpStatus.NOT_FOUND, \"서버를 찾을 수 없습니다\"));\n        return customGameRepo.findByServer(srv).stream()\n                .map(cg -> new GameDto.CustomGameResponse(cg.getId(), cg.getName()))\n                .collect(Collectors.toList());\n    }\n\n    /* ---------- 커스텀 게임 추가 / 삭제 ---------- */\n\n    public GameDto.CustomGameResponse addCustomGame(Long serverId, GameDto.CustomGameRequest req) {\n        Server srv = serverRepo.findById(serverId)\n                .orElseThrow(() -> new ResponseStatusException(HttpStatus.NOT_FOUND, \"서버를 찾을 수 없습니다\"));\n\n        CustomGame cg = CustomGame.builder()\n                .name(req.getName())\n                .server(srv)\n                .build();\n\n        cg = customGameRepo.save(cg);\n        return new GameDto.CustomGameResponse(cg.getId(), cg.getName());\n    }\n\n    /**\n     * 1) 커스텀 게임을 예약해 놓은 유저 목록 조회\n     */\n    public GameDto.ScheduledUserListResponse listScheduledUsers(Long serverId, Long gameId) {\n        Server srv = serverRepo.findById(serverId)\n                .orElseThrow(() -> new ResponseStatusException(HttpStatus.NOT_FOUND, \"서버를 찾을 수 없습니다\"));\n        CustomGame cg = customGameRepo.findById(gameId)\n                .orElseThrow(() -> new ResponseStatusException(HttpStatus.NOT_FOUND, \"게임을 찾을 수 없습니다\"));\n\n        if (!cg.getServer().getId().equals(serverId)) {\n            throw new ResponseStatusException(HttpStatus.BAD_REQUEST, \"해당 서버의 게임이 아닙니다\");\n        }\n\n        List<GameDto.ScheduledUserResponse> users = entryRepo.findByCustomGame(cg).stream()\n                .map(e -> e.getUser().getUsername())\n                .distinct()\n                .map(GameDto.ScheduledUserResponse::new)\n                .collect(Collectors.toList());\n\n        return new GameDto.ScheduledUserListResponse(users);\n    }\n\n    /**\n     * 2) 커스텀 게임 삭제 (엔트리 먼저 삭제 → 게임 삭제)\n     */\n    @Transactional\n    public void deleteCustomGame(Long serverId, Long gameId) {\n        Server srv = serverRepo.findById(serverId)\n                .orElseThrow(() -> new ResponseStatusException(HttpStatus.NOT_FOUND, \"서버를 찾을 수 없습니다\"));\n        CustomGame cg = customGameRepo.findById(gameId)\n                .orElseThrow(() -> new ResponseStatusException(HttpStatus.NOT_FOUND, \"게임을 찾을 수 없습니다\"));\n\n        // 권한 검사 (owner 또는 admin)\n        String current = SecurityContextHolder.getContext().getAuthentication().getName();\n        if (!(srv.getOwner().getUsername().equals(current) || srv.getAdmins().stream()\n                .anyMatch(u -> u.getUsername().equals(current)))) {\n            throw new ResponseStatusException(HttpStatus.FORBIDDEN, \"관리자 권한이 필요합니다\");\n        }\n\n        // ① 해당 게임을 예약한 모든 타임테이블 엔트리 삭제\n        entryRepo.deleteAllByCustomGame(cg);\n\n        // ② 커스텀 게임 자체 삭제\n        customGameRepo.delete(cg);\n    }\n}\n",
            "ServerService.java": "// service/ServerService.java\npackage com.example.scheduler.service;\n\nimport com.example.scheduler.domain.Server;\nimport com.example.scheduler.domain.User;\nimport com.example.scheduler.dto.ServerDto;\nimport com.example.scheduler.repository.ServerRepository;\nimport com.example.scheduler.repository.UserRepository;\nimport lombok.RequiredArgsConstructor;\nimport org.springframework.data.domain.Page;\nimport org.springframework.data.domain.PageRequest;\nimport org.springframework.http.HttpStatus;\nimport org.springframework.security.core.context.SecurityContextHolder;\nimport org.springframework.stereotype.Service;\nimport org.springframework.web.server.ResponseStatusException;\n\nimport java.util.List;\nimport java.util.Set;\nimport java.util.stream.Collectors;\n\n@Service\n@RequiredArgsConstructor\npublic class ServerService {\n\n    private final ServerRepository serverRepo;\n    private final UserRepository userRepo;\n\n    /* ---------- 생성 / 참가 ---------- */\n    /** 내가 참여한 서버들만 조회 */\n    public List<ServerDto.Response> listMine() {\n        User me = currentUser();\n        return serverRepo.findByMembersContains(me).stream()\n                .map(this::toDto)\n                .collect(Collectors.toList());\n    }\n\n    public List<ServerDto.Response> search(String q, int page, int size) {\n        Page<Server> pg = serverRepo.findByNameContainingIgnoreCase(\n                q == null ? \"\" : q,\n                PageRequest.of(page, size)\n        );\n        return pg.getContent().stream()\n                .map(this::toDto)\n                .collect(Collectors.toList());\n    }\n    public ServerDto.Response create(ServerDto.CreateRequest req) {\n        User owner = currentUser();\n\n        Server srv = Server.builder()\n                .name(req.getName())\n                .owner(owner)\n                .members(Set.of(owner))\n                .admins(Set.of(owner))          // ⭐ owner → admins\n                .resetTime(req.getResetTime())\n                .build();\n\n        serverRepo.save(srv);\n        return toDto(srv);\n    }\n\n    public ServerDto.Response join(Long serverId) {\n        User user = currentUser();\n        Server srv = fetch(serverId);\n\n        if (srv.getMembers().contains(user)) {\n            throw new ResponseStatusException(HttpStatus.BAD_REQUEST, \"이미 참가한 서버입니다\");\n        }\n        srv.getMembers().add(user);\n        serverRepo.save(srv);\n        return toDto(srv);\n    }\n\n    /* ---------- 일반 수정 ---------- */\n\n    public ServerDto.Response updateResetTime(Long id, ServerDto.UpdateResetTimeRequest req) {\n        Server srv = fetch(id);\n        assertAdmin(srv, currentUser());\n\n        srv.setResetTime(req.getResetTime());\n        serverRepo.save(srv);\n        return toDto(srv);\n    }\n\n    public ServerDto.Response rename(Long id, ServerDto.UpdateNameRequest req) { // ⭐ 서버 이름 변경\n        Server srv = fetch(id);\n        assertAdmin(srv, currentUser());\n\n        srv.setName(req.getName());\n        serverRepo.save(srv);\n        return toDto(srv);\n    }\n\n    /* ---------- 관리자 기능 ---------- */\n\n    public ServerDto.Response kick(Long id, ServerDto.KickRequest req) {\n        Server srv = fetch(id);\n        User me = currentUser();\n        assertAdmin(srv, me);\n\n        User target = userRepo.findById(req.getUserId())\n                .orElseThrow(() -> new ResponseStatusException(HttpStatus.NOT_FOUND));\n\n        if (srv.getOwner().equals(target))\n            throw new ResponseStatusException(HttpStatus.BAD_REQUEST, \"서버장은 강퇴할 수 없습니다\");\n\n        srv.getMembers().remove(target);\n        srv.getAdmins().remove(target);\n        serverRepo.save(srv);\n        return toDto(srv);\n    }\n\n    public ServerDto.Response updateAdmin(Long id, ServerDto.AdminRequest req) {\n        Server srv = fetch(id);\n        User me = currentUser();\n        assertAdmin(srv, me);\n\n        User target = userRepo.findById(req.getUserId())\n                .orElseThrow(() -> new ResponseStatusException(HttpStatus.NOT_FOUND));\n\n        if (!srv.getMembers().contains(target))\n            throw new ResponseStatusException(HttpStatus.BAD_REQUEST, \"서버 멤버가 아닙니다\");\n\n        if (req.isGrant()) {                 // 임명\n            srv.getAdmins().add(target);\n        } else {                             // 해제\n            if (srv.getOwner().equals(target))\n                throw new ResponseStatusException(HttpStatus.BAD_REQUEST, \"서버장은 항상 관리자입니다\");\n            srv.getAdmins().remove(target);\n        }\n        serverRepo.save(srv);\n        return toDto(srv);\n    }\n\n    public void delete(Long id) {            // ⭐ 서버 삭제\n        Server srv = fetch(id);\n        User me = currentUser();\n\n        if (!srv.getOwner().equals(me))\n            throw new ResponseStatusException(HttpStatus.FORBIDDEN, \"서버장만 삭제할 수 있습니다\");\n\n        serverRepo.delete(srv);\n    }\n\n    /* ---------- 조회 ---------- */\n\n    public List<ServerDto.Response> list() {\n        return serverRepo.findAll().stream()\n                .map(this::toDto)\n                .collect(Collectors.toList());\n    }\n\n    public ServerDto.Response getDetail(Long id) {\n        Server srv = fetch(id);\n        User me = currentUser();\n        if (!srv.getMembers().contains(me))\n            throw new ResponseStatusException(HttpStatus.FORBIDDEN, \"서버 멤버가 아닙니다\");\n\n        return toDto(srv);\n    }\n\n    /* ---------- 내부 도우미 ---------- */\n\n    private User currentUser() {\n        String username = SecurityContextHolder.getContext().getAuthentication().getName();\n        return userRepo.findByUsername(username).orElseThrow();\n    }\n\n    private Server fetch(Long id) {\n        return serverRepo.findById(id)\n                .orElseThrow(() -> new ResponseStatusException(HttpStatus.NOT_FOUND));\n    }\n\n    private void assertAdmin(Server srv, User user) {\n        if (!(srv.getOwner().equals(user) || srv.getAdmins().contains(user))) {\n            throw new ResponseStatusException(HttpStatus.FORBIDDEN, \"관리자 권한이 필요합니다\");\n        }\n    }\n\n    private ServerDto.Response toDto(Server s) {\n        List<ServerDto.MemberInfo> mems = s.getMembers().stream()\n                .map(u -> new ServerDto.MemberInfo(u.getId(), u.getUsername()))\n                .collect(Collectors.toList());\n\n        List<ServerDto.MemberInfo> adms = s.getAdmins().stream()\n                .map(u -> new ServerDto.MemberInfo(u.getId(), u.getUsername()))\n                .collect(Collectors.toList());\n\n        return new ServerDto.Response(\n                s.getId(),\n                s.getName(),\n                s.getOwner().getUsername(),\n                mems,\n                adms,\n                s.getResetTime()\n        );\n    }\n}\n",
            "TimetableService.java": "package com.example.scheduler.service;\n\nimport com.example.scheduler.domain.*;\nimport com.example.scheduler.dto.TimetableDto;\nimport com.example.scheduler.repository.*;\nimport jakarta.transaction.Transactional;\nimport lombok.RequiredArgsConstructor;\nimport org.springframework.http.HttpStatus;\nimport org.springframework.security.core.context.SecurityContextHolder;\nimport org.springframework.stereotype.Service;\nimport org.springframework.web.server.ResponseStatusException;\n\nimport java.time.LocalDateTime;\nimport java.time.temporal.ChronoUnit;\nimport java.util.Comparator;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.stream.Collectors;\n\n@Service\n@RequiredArgsConstructor\npublic class TimetableService {\n    private final TimetableEntryRepository entryRepo;\n    private final ServerRepository serverRepo;\n    private final UserRepository userRepo;\n    private final DefaultGameRepository defaultGameRepo;\n    private final CustomGameRepository customGameRepo;\n\n    @Transactional\n    public TimetableDto.EntryResponse add(TimetableDto.EntryRequest req) {\n        User user = userRepo.findByUsername(\n                SecurityContextHolder.getContext().getAuthentication().getName()\n        ).orElseThrow(() -> new ResponseStatusException(HttpStatus.NOT_FOUND));\n        Server srv = serverRepo.findById(req.getServerId())\n                .orElseThrow(() -> new ResponseStatusException(HttpStatus.NOT_FOUND));\n\n        entryRepo.findByServerAndUser(srv, user)\n                .ifPresent(entryRepo::delete);\n\n        TimetableEntry e = TimetableEntry.builder()\n                .server(srv)\n                .user(user)\n                .slot(req.getSlot().truncatedTo(ChronoUnit.MINUTES))\n                .build();\n\n        if (req.getCustomGameId() != null) {\n            CustomGame cg = customGameRepo.findById(req.getCustomGameId())\n                    .orElseThrow(() -> new ResponseStatusException(HttpStatus.BAD_REQUEST, \"Invalid customGameId\"));\n            e.setCustomGame(cg);\n        } else if (req.getDefaultGameId() != null) {\n            DefaultGame dg = defaultGameRepo.findById(req.getDefaultGameId())\n                    .orElseThrow(() -> new ResponseStatusException(HttpStatus.BAD_REQUEST, \"Invalid defaultGameId\"));\n            e.setDefaultGame(dg);\n        } else {\n            throw new ResponseStatusException(HttpStatus.BAD_REQUEST, \"Game ID is required\");\n        }\n\n        entryRepo.save(e);\n        return toResp(e);\n    }\n\n    public List<TimetableDto.EntryResponse> list(\n            Long serverId, String gameName, boolean sortByGame\n    ) {\n        Server srv = serverRepo.findById(serverId)\n                .orElseThrow(() -> new ResponseStatusException(HttpStatus.NOT_FOUND));\n\n        // 1) 서버 전체 엔트리 조회\n        List<TimetableEntry> list = entryRepo.findByServerOrderBySlot(srv);\n\n        // 2) 이름 기준 필터링 (gameName 파라미터 존재 시)\n        if (gameName != null) {\n            list = list.stream()\n                    .filter(e -> {\n                        String name = (e.getCustomGame() != null)\n                                ? e.getCustomGame().getName()\n                                : e.getDefaultGame().getName();\n                        return name.equals(gameName);\n                    })\n                    .collect(Collectors.toList());\n        }\n\n        // 3) 게임명 기준 정렬\n        if (sortByGame) {\n            list.sort(Comparator.comparing(e -> {\n                return (e.getCustomGame() != null)\n                        ? e.getCustomGame().getName()\n                        : e.getDefaultGame().getName();\n            }));\n        }\n\n        return list.stream().map(this::toResp).collect(Collectors.toList());\n    }\n\n    public TimetableDto.StatsResponse stats(Long serverId) {\n        Server srv = serverRepo.findById(serverId)\n                .orElseThrow(() -> new ResponseStatusException(HttpStatus.NOT_FOUND));\n        List<TimetableEntry> list = entryRepo.findByServerOrderBySlot(srv);\n\n        // 최다 플레이 게임\n        String topGame = list.stream()\n                .collect(Collectors.groupingBy(e -> {\n                    return (e.getCustomGame() != null)\n                            ? e.getCustomGame().getName()\n                            : e.getDefaultGame().getName();\n                }, Collectors.counting()))\n                .entrySet().stream()\n                .max(Map.Entry.comparingByValue())\n                .get().getKey();\n\n        // 슬롯별 카운트\n        Map<LocalDateTime, Long> slotCounts = list.stream()\n                .collect(Collectors.groupingBy(TimetableEntry::getSlot, Collectors.counting()));\n\n        // 피크 슬롯과 평균 슬롯\n        LocalDateTime peakSlot = slotCounts.entrySet().stream()\n                .max(Map.Entry.comparingByValue())\n                .get().getKey();\n\n        double avgMinute = list.stream()\n                .mapToLong(e -> e.getSlot().getHour() * 60 + e.getSlot().getMinute())\n                .average().orElse(0);\n\n        LocalDateTime avgSlot = LocalDateTime.now()\n                .withHour((int)avgMinute / 60)\n                .withMinute((int)avgMinute % 60)\n                .truncatedTo(ChronoUnit.MINUTES);\n\n        int peakCount = slotCounts.get(peakSlot).intValue();\n        return new TimetableDto.StatsResponse(topGame, avgSlot, peakSlot, peakCount);\n    }\n\n    private TimetableDto.EntryResponse toResp(TimetableEntry e) {\n        TimetableDto.EntryResponse r = new TimetableDto.EntryResponse();\n        r.setId(e.getId());\n        r.setUser(e.getUser().getUsername());\n        r.setSlot(e.getSlot());\n        if (e.getCustomGame() != null) {\n            r.setGameId(e.getCustomGame().getId());\n            r.setGameName(e.getCustomGame().getName());\n            r.setCustom(true);\n        } else {\n            r.setGameId(e.getDefaultGame().getId());\n            r.setGameName(e.getDefaultGame().getName());\n            r.setCustom(false);\n        }\n        return r;\n    }\n}\n"
        }
    }
}